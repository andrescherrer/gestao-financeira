# FE-OBS-001: Logging Estruturado no Frontend

**Data:** 2025-12-31  
**Tarefa:** FE-OBS-001  
**Status:** ‚úÖ Completo  
**Tipo:** üü£ Frontend | Observabilidade

---

## üìã Problema

O frontend estava usando apenas `console.log`, `console.error`, etc., espalhados pelo c√≥digo, sem estrutura√ß√£o, contexto ou integra√ß√£o com o sistema de observabilidade do backend. Isso dificultava:

- Debug em produ√ß√£o
- Rastreamento de erros
- Correla√ß√£o de logs entre frontend e backend
- Contexto de usu√°rio nos logs
- An√°lise de problemas do usu√°rio

---

## ‚úÖ Solu√ß√£o Implementada

Foi implementado um sistema completo de logging estruturado no frontend com:

1. **Sistema de Logging Estruturado** (`frontend/src/utils/logger.ts`)
   - N√≠veis de log: debug, info, warn, error
   - Logging estruturado com contexto JSON
   - Contexto de usu√°rio (user_id, email)
   - Correlation IDs (request_id, trace_id, span_id)
   - Timestamp autom√°tico
   - URL e user agent

2. **Integra√ß√£o com Backend**
   - Endpoint `/api/v1/logs` para receber logs do frontend
   - Envio autom√°tico de logs em lote (10 logs ou erro)
   - Envio de logs pendentes antes de fechar a p√°gina (sendBeacon)
   - Fila de logs com limite para evitar crescimento infinito

3. **Integra√ß√£o no C√≥digo**
   - Substitui√ß√£o de `console.log` por `logger` no `apiClient`
   - Integra√ß√£o na store de auth para capturar contexto do usu√°rio
   - Captura de erros globais (window.error, unhandledrejection)
   - Error handler do Vue configurado

4. **Testes Unit√°rios**
   - Testes para todos os n√≠veis de log
   - Testes para contexto de usu√°rio
   - Testes para correlation IDs
   - Testes para tratamento de erros

---

## üìÅ Arquivos Criados

### Frontend
- `frontend/src/utils/logger.ts` - Sistema de logging estruturado (350+ linhas)
- `frontend/src/utils/__tests__/logger.test.ts` - Testes unit√°rios (150+ linhas)

### Backend
- `backend/internal/shared/presentation/handlers/log_handler.go` - Handler para receber logs do frontend (120+ linhas)

---

## üìù Arquivos Modificados

### Frontend
- `frontend/src/main.ts`
  - Importa√ß√£o e inicializa√ß√£o do logger
  - Configura√ß√£o de captura de erros globais (window.error, unhandledrejection)
  - Error handler do Vue configurado
  - Log de inicializa√ß√£o da aplica√ß√£o

- `frontend/src/api/client.ts`
  - Substitui√ß√£o de `console.log` por `logger.debug` para logs de token
  - Substitui√ß√£o de `console.warn` por `logger.warn` para avisos
  - Substitui√ß√£o de `console.error` por `logger.error` para erros
  - Captura de correlation IDs dos headers de resposta
  - Logs estruturados com contexto completo

- `frontend/src/stores/auth.ts`
  - Integra√ß√£o do logger para capturar contexto do usu√°rio
  - Log de login/logout
  - Log de registro
  - Log de erros de valida√ß√£o de token
  - Atualiza√ß√£o do contexto do usu√°rio no logger

### Backend
- `backend/cmd/api/main.go`
  - Adi√ß√£o da rota `/api/v1/logs` para receber logs do frontend
  - Importa√ß√£o do handler de logs

---

## üéØ Caracter√≠sticas Implementadas

### 1. Sistema de Logging Estruturado
- ‚úÖ N√≠veis de log configur√°veis (debug, info, warn, error)
- ‚úÖ Logging estruturado com contexto JSON
- ‚úÖ Timestamp autom√°tico em ISO 8601
- ‚úÖ Contexto de requisi√ß√£o (URL, user agent, environment)

### 2. Contexto de Usu√°rio
- ‚úÖ Captura autom√°tica de user_id e email
- ‚úÖ Atualiza√ß√£o do contexto ao fazer login
- ‚úÖ Limpeza do contexto ao fazer logout
- ‚úÖ Contexto inclu√≠do em todos os logs

### 3. Correlation IDs
- ‚úÖ Captura autom√°tica de request_id, trace_id, span_id dos headers
- ‚úÖ Gera√ß√£o de request_id local quando n√£o dispon√≠vel
- ‚úÖ Propaga√ß√£o de correlation IDs entre frontend e backend

### 4. Integra√ß√£o com Backend
- ‚úÖ Endpoint `/api/v1/logs` para receber logs
- ‚úÖ Envio autom√°tico de logs em lote (10 logs ou erro)
- ‚úÖ Envio de logs pendentes antes de fechar a p√°gina
- ‚úÖ Fila de logs com limite (100 logs) para evitar crescimento infinito
- ‚úÖ Graceful degradation (n√£o quebra a aplica√ß√£o se falhar)

### 5. Captura de Erros Globais
- ‚úÖ Captura de erros n√£o tratados (window.error)
- ‚úÖ Captura de promessas rejeitadas (unhandledrejection)
- ‚úÖ Error handler do Vue configurado
- ‚úÖ Logs estruturados com stack trace

### 6. Testes
- ‚úÖ Testes unit√°rios para todos os n√≠veis de log
- ‚úÖ Testes para contexto de usu√°rio
- ‚úÖ Testes para correlation IDs
- ‚úÖ Testes para tratamento de erros

---

## üîß Configura√ß√£o

### Vari√°veis de Ambiente (Opcional)
- `VITE_ENABLE_CONSOLE_LOGS` - Habilitar logs no console (padr√£o: true em dev)
- `VITE_ENABLE_BACKEND_LOGS` - Habilitar envio de logs para backend (padr√£o: true em produ√ß√£o)
- `VITE_LOG_LEVEL` - N√≠vel m√≠nimo de log (debug, info, warn, error)

### Uso do Logger

```typescript
import { logger } from '@/utils/logger'

// Log de debug
logger.debug('Mensagem de debug', { context: 'data' })

// Log de info
logger.info('Mensagem de informa√ß√£o', { userId: '123' })

// Log de aviso
logger.warn('Mensagem de aviso', { warning: 'data' })

// Log de erro
logger.error('Mensagem de erro', error, { context: 'data' })

// Definir contexto do usu√°rio
logger.setUserContext('user-123', 'user@example.com')

// Definir correlation IDs
logger.setCorrelationIds('req-123', 'trace-456', 'span-789')

// Gerar novo request ID
const requestId = logger.newRequestId()
```

---

## üìä Estat√≠sticas

- **Arquivos criados:** 3
- **Arquivos modificados:** 4
- **Linhas de c√≥digo adicionadas:** ~750
- **Testes criados:** 1 arquivo com m√∫ltiplos testes
- **Endpoints criados:** 1 (`/api/v1/logs`)

---

## ‚úÖ Valida√ß√£o

### Testes
- ‚úÖ Testes unit√°rios criados e passando
- ‚úÖ Cobertura de todos os n√≠veis de log
- ‚úÖ Cobertura de contexto de usu√°rio
- ‚úÖ Cobertura de correlation IDs
- ‚úÖ Cobertura de tratamento de erros

### Funcionalidade
- ‚úÖ Logger funciona corretamente em desenvolvimento
- ‚úÖ Logger envia logs para backend em produ√ß√£o
- ‚úÖ Contexto de usu√°rio √© capturado corretamente
- ‚úÖ Correlation IDs s√£o propagados corretamente
- ‚úÖ Erros globais s√£o capturados e logados
- ‚úÖ Logs n√£o quebram a aplica√ß√£o se falharem

---

## üöÄ Pr√≥ximos Passos (Opcional)

1. **Dashboard de Logs**
   - Criar dashboard no Grafana para visualizar logs do frontend
   - Filtrar logs por usu√°rio, n√≠vel, etc.

2. **Alertas**
   - Configurar alertas para erros cr√≠ticos do frontend
   - Alertas baseados em padr√µes de erro

3. **An√°lise de Erros**
   - Agrupar erros similares
   - Identificar padr√µes de erro
   - Correlacionar erros com a√ß√µes do usu√°rio

---

## üìö Refer√™ncias

- [Structured Logging Best Practices](https://www.structlog.org/en/stable/)
- [Frontend Logging Patterns](https://blog.logrocket.com/frontend-logging-best-practices/)
- [Correlation IDs](https://microservices.io/patterns/observability/correlation-id.html)

---

## üíæ Commits

- `62b12c0` - feat(frontend): implementar logging estruturado no frontend

---

**Implementado por:** AI Assistant  
**Revisado por:** -  
**Aprovado por:** -

