# INV-002: Criar entidade Investment

**Data:** 2025-12-31  
**Tarefa:** INV-002  
**Status:** âœ… Completo  
**Tipo:** ğŸ”µ Backend | Domain

---

## ğŸ“‹ Problema

Para implementar o contexto de Investment, era necessÃ¡rio criar a entidade Investment (agregado raiz) que representa um investimento financeiro no domÃ­nio. A entidade deve encapsular as regras de negÃ³cio relacionadas a investimentos, incluindo cÃ¡lculo de retorno, atualizaÃ§Ã£o de valor e gerenciamento de quantidade.

---

## âœ… SoluÃ§Ã£o Implementada

Foi criada a entidade Investment seguindo o padrÃ£o DDD estabelecido no projeto, com:

1. **Estrutura da Entidade**
   - ID, UserID, AccountID
   - Tipo de investimento, nome (com ticker opcional)
   - Data de compra, valor de compra, valor atual
   - Quantidade (opcional, depende do tipo)
   - Contexto (PERSONAL/BUSINESS)
   - Timestamps (createdAt, updatedAt)

2. **Comportamentos de DomÃ­nio**
   - `UpdateCurrentValue()` - Atualiza valor atual e calcula retorno
   - `CalculateReturn()` - Calcula retorno absoluto e percentual
   - `CalculateReturnPercentage()` - Calcula apenas o percentual
   - `AddQuantity()` - Adiciona quantidade (para tipos que requerem)
   - `RemoveQuantity()` - Remove quantidade (para tipos que requerem)

3. **Eventos de DomÃ­nio**
   - `InvestmentCreated` - Quando investimento Ã© criado
   - `InvestmentValueUpdated` - Quando valor atual Ã© atualizado
   - `InvestmentReturnCalculated` - Quando retorno Ã© calculado

---

## ğŸ“ Arquivos Criados

### Domain Events
- `backend/internal/investment/domain/events/investment_created.go` - Evento de criaÃ§Ã£o
- `backend/internal/investment/domain/events/investment_value_updated.go` - Evento de atualizaÃ§Ã£o de valor
- `backend/internal/investment/domain/events/investment_return_calculated.go` - Evento de cÃ¡lculo de retorno

### Entity
- `backend/internal/investment/domain/entities/investment.go` - Entidade Investment (agregado raiz)

### Testes
- `backend/internal/investment/domain/entities/investment_test.go` - Testes para entidade Investment

---

## ğŸ¯ CaracterÃ­sticas Implementadas

### 1. ValidaÃ§Ãµes na CriaÃ§Ã£o
- âœ… UserID nÃ£o pode ser vazio
- âœ… AccountID nÃ£o pode ser vazio
- âœ… Nome nÃ£o pode ser vazio
- âœ… Data de compra nÃ£o pode ser zero ou futura
- âœ… Valor de compra nÃ£o pode ser zero ou negativo
- âœ… Quantidade obrigatÃ³ria para tipos que requerem (STOCK, FUND, CRYPTO)
- âœ… Quantidade deve ser positiva quando fornecida

### 2. Comportamentos de DomÃ­nio
- âœ… **UpdateCurrentValue**: Atualiza valor atual e emite eventos
  - Valida que valor nÃ£o Ã© negativo
  - Valida que moeda corresponde
  - Calcula e emite retorno automaticamente
  
- âœ… **CalculateReturn**: Calcula retorno do investimento
  - Retorno absoluto (currentValue - purchaseAmount)
  - Retorno percentual ((absolute / purchaseAmount) * 100)
  - Retorna InvestmentReturn value object
  
- âœ… **AddQuantity**: Adiciona quantidade ao investimento
  - Valida que tipo requer quantidade
  - Valida que quantidade Ã© positiva
  - Atualiza timestamp
  
- âœ… **RemoveQuantity**: Remove quantidade do investimento
  - Valida que tipo requer quantidade
  - Valida que quantidade Ã© positiva
  - Valida que hÃ¡ quantidade suficiente
  - Remove completamente se chegar a zero

### 3. Eventos de DomÃ­nio
- âœ… **InvestmentCreated**: Emitido na criaÃ§Ã£o
  - ContÃ©m todos os dados relevantes do investimento
  
- âœ… **InvestmentValueUpdated**: Emitido ao atualizar valor
  - ContÃ©m novo valor atual e moeda
  
- âœ… **InvestmentReturnCalculated**: Emitido ao calcular retorno
  - ContÃ©m retorno absoluto, percentual e moeda

### 4. PersistÃªncia
- âœ… `InvestmentFromPersistence()` - ReconstrÃ³i entidade de dados persistidos
- âœ… NÃ£o emite eventos ao reconstruir (apenas ao criar/atualizar)

---

## ğŸ“Š Estrutura da Entidade

```go
type Investment struct {
    id             InvestmentID
    userID         UserID
    accountID      AccountID
    investmentType InvestmentType
    name           InvestmentName
    purchaseDate   time.Time
    purchaseAmount Money
    currentValue   Money
    quantity       *float64 // Opcional
    context        AccountContext
    createdAt      time.Time
    updatedAt     time.Time
    events         []DomainEvent
}
```

---

## âœ… Testes Implementados

### Cobertura de Testes
- âœ… **NewInvestment**: 12 testes (validaÃ§Ãµes de criaÃ§Ã£o)
- âœ… **UpdateCurrentValue**: 5 testes (validaÃ§Ãµes e eventos)
- âœ… **CalculateReturn**: 1 teste (cÃ¡lculo de retorno)
- âœ… **AddQuantity**: 4 testes (validaÃ§Ãµes e tipos)
- âœ… **RemoveQuantity**: 6 testes (validaÃ§Ãµes e casos edge)
- âœ… **InvestmentFromPersistence**: 1 teste (reconstruÃ§Ã£o)

**Total:** 29 testes unitÃ¡rios, todos passando âœ…

### Casos de Teste Cobertos
- âœ… CriaÃ§Ã£o vÃ¡lida com e sem quantidade
- âœ… ValidaÃ§Ãµes de campos obrigatÃ³rios
- âœ… ValidaÃ§Ã£o de data futura
- âœ… ValidaÃ§Ã£o de valores negativos/zero
- âœ… ValidaÃ§Ã£o de quantidade por tipo
- âœ… AtualizaÃ§Ã£o de valor atual
- âœ… CÃ¡lculo de retorno (positivo e negativo)
- âœ… AdiÃ§Ã£o e remoÃ§Ã£o de quantidade
- âœ… ReconstruÃ§Ã£o de persistÃªncia

---

## ğŸ” Regras de NegÃ³cio Implementadas

### 1. Quantidade por Tipo
- **STOCK, FUND, CRYPTO**: Requerem quantidade obrigatÃ³ria
- **CDB, TREASURY, OTHER**: NÃ£o requerem quantidade

### 2. Valor Inicial
- Valor atual inicia igual ao valor de compra
- Pode ser atualizado posteriormente

### 3. CÃ¡lculo de Retorno
- Retorno absoluto = currentValue - purchaseAmount
- Retorno percentual = (absolute / purchaseAmount) * 100
- Retorno Ã© calculado automaticamente ao atualizar valor

### 4. Eventos
- Eventos sÃ£o emitidos automaticamente em operaÃ§Ãµes de domÃ­nio
- Eventos podem ser recuperados via `GetEvents()`
- Eventos podem ser limpos via `ClearEvents()`

---

## ğŸ“ PadrÃµes Seguidos

1. **Agregado Raiz**: Investment Ã© o agregado raiz do contexto
2. **Imutabilidade**: Campos privados, acesso via getters
3. **ValidaÃ§Ã£o no construtor**: Todas as validaÃ§Ãµes na criaÃ§Ã£o
4. **Domain Events**: Eventos emitidos automaticamente
5. **Encapsulamento**: Regras de negÃ³cio encapsuladas na entidade
6. **Testes completos**: 100% de cobertura com testes unitÃ¡rios

---

## ğŸ”— DependÃªncias

- âœ… Value Objects criados em INV-001
- âœ… `gestao-financeira/backend/internal/shared/domain/valueobjects` - Money, Currency, AccountContext
- âœ… `gestao-financeira/backend/internal/account/domain/valueobjects` - AccountID
- âœ… `gestao-financeira/backend/internal/identity/domain/valueobjects` - UserID

---

## ğŸ“ˆ PrÃ³ximos Passos

Com a entidade implementada, podemos prosseguir para:
- **INV-003**: Implementar repositÃ³rio e use cases
- **INV-004**: Criar handlers e rotas

---

## âœ… ValidaÃ§Ã£o

- âœ… Todos os testes passando (29 testes)
- âœ… Sem erros de lint
- âœ… Seguindo padrÃµes DDD do projeto
- âœ… DocumentaÃ§Ã£o completa
- âœ… CÃ³digo revisado e validado
- âœ… Eventos de domÃ­nio implementados

---

## ğŸ“š ReferÃªncias

- [Domain-Driven Design - Entities](https://martinfowler.com/bliki/DDD_Aggregate.html)
- PadrÃµes estabelecidos em `backend/internal/account/domain/entities`
- PadrÃµes estabelecidos em `backend/internal/transaction/domain/entities`

---

**Ãšltima AtualizaÃ§Ã£o:** 2025-12-31  
**Commit:** `[hash]` - feat(investment): implementar INV-002 - entidade Investment

