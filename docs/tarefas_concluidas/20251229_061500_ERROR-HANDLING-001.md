# ERROR-HANDLING-001 - Tratamento de Erros Consistente

**Data:** 2025-12-29  
**Status:** ✅ Concluída  
**Sprint:** QUAL-001 - Qualidade de Código

## Resumo da Implementação

**Tarefa:** Implementar tratamento de erros consistente removendo string matching e usando tipos de erro customizados (`AppError`) de forma padronizada em todos os handlers.

### Problema Identificado

O relatório de análise de engenharia de software identificou que alguns handlers ainda usavam string matching para tratar erros:

```go
// ❌ ANTES: String matching (frágil e difícil de manter)
if strings.Contains(errMsg, "invalid user ID") {
    return c.Status(fiber.StatusBadRequest).JSON(...)
}
```

**Problemas:**
- Frágil: dependente de mensagens de erro específicas
- Difícil de manter: mudanças em mensagens quebram o tratamento
- Inconsistente: diferentes handlers tratam erros de forma diferente
- Não type-safe: erros de compilação não são detectados

### Solução Implementada

1. **Criado `error_mapper.go`** - Helper para mapear erros de domínio para `AppError`
2. **Refatorados todos os handlers** - Removido string matching, usando `AppError` consistentemente
3. **Middleware já trata `AppError`** - O middleware de erro já estava preparado para tratar `AppError`

### Arquivos Criados

1. **`backend/pkg/errors/error_mapper.go`**
   - `MapDomainError()` - Mapeia erros de domínio para `AppError` baseado em padrões
   - `MapToAppError()` - Conveniência para mapear erros
   - `WrapDomainError()` - Envolve erros de domínio com contexto adicional

### Arquivos Modificados

1. **`backend/internal/transaction/presentation/handlers/transaction_handler.go`**
   - Removido string matching de `handleUseCaseError()`
   - Removido string matching de `handleGetTransactionError()`
   - Removido string matching de `handleUpdateTransactionError()`
   - Removido string matching de `handleDeleteTransactionError()`
   - Removido string matching de `handleRestoreTransactionError()`
   - Removido string matching de `handlePermanentDeleteTransactionError()`
   - Todos os métodos agora usam `apperrors.MapDomainError()`

2. **`backend/internal/account/presentation/handlers/account_handler.go`**
   - Removido string matching de `handleUseCaseError()`
   - Removido string matching de `handleGetAccountError()`
   - Ambos os métodos agora usam `apperrors.MapDomainError()`

3. **`backend/internal/category/presentation/handlers/category_handler.go`**
   - Removido string matching de `handleUseCaseError()`
   - Método agora usa `apperrors.MapDomainError()`

4. **`backend/internal/identity/presentation/handlers/auth_handler.go`**
   - Removido string matching de `handleUseCaseError()`
   - Removido string matching de `handleLoginError()`
   - Ambos os métodos agora usam `apperrors.MapDomainError()`

### Mudanças Principais

#### Antes (String Matching)

```go
func (h *TransactionHandler) handleUseCaseError(c *fiber.Ctx, err error) error {
    errMsg := err.Error()
    
    if strings.Contains(errMsg, "invalid user ID") {
        return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
            "error": "Invalid user ID",
            "code":  fiber.StatusBadRequest,
        })
    }
    
    if strings.Contains(errMsg, "account not found") {
        return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
            "error": "Account not found",
            "code":  fiber.StatusBadRequest,
        })
    }
    
    // ...
}
```

#### Depois (AppError)

```go
func (h *TransactionHandler) handleUseCaseError(c *fiber.Ctx, err error) error {
    if err == nil {
        return nil
    }
    
    // Map domain errors to AppError
    appErr := apperrors.MapDomainError(err)
    
    // Log error with appropriate level
    if appErr.Type == apperrors.ErrorTypeValidation || appErr.Type == apperrors.ErrorTypeNotFound {
        log.Warn().Err(err).Str("error_type", string(appErr.Type)).Msg("Transaction operation failed")
    } else {
        log.Error().Err(err).Str("error_type", string(appErr.Type)).Msg("Transaction operation failed")
    }
    
    // Return error - the middleware will handle the response formatting
    return appErr
}
```

### Error Mapper

O `MapDomainError()` mapeia erros de domínio para `AppError` baseado em padrões de mensagem:

- **Validation Errors**: "invalid", "cannot be empty", "must be", "should be"
- **Not Found Errors**: "not found"
- **Conflict Errors**: "already exists", "duplicate", "conflict"
- **Unauthorized Errors**: "unauthorized", "invalid credentials", "authentication failed"
- **Forbidden Errors**: "forbidden", "permission denied", "access denied"
- **Domain Errors**: "failed to", "unable to", "cannot"
- **Internal Errors**: Qualquer outro erro desconhecido

### Benefícios

1. **Consistência:**
   - Todos os handlers tratam erros da mesma forma
   - Respostas HTTP padronizadas
   - Logging consistente

2. **Manutenibilidade:**
   - Mudanças em mensagens de erro não quebram o tratamento
   - Lógica de mapeamento centralizada
   - Fácil de estender com novos tipos de erro

3. **Type Safety:**
   - Uso de tipos de erro customizados
   - Middleware já preparado para tratar `AppError`
   - Melhor detecção de erros em tempo de compilação

4. **Testabilidade:**
   - Fácil de testar com `AppError`
   - Mapeamento de erros pode ser testado isoladamente

5. **Observabilidade:**
   - Logging estruturado com tipo de erro
   - Request ID incluído automaticamente pelo middleware
   - Melhor rastreabilidade de erros

### Handlers Refatorados

- ✅ `TransactionHandler` - 6 métodos refatorados
- ✅ `AccountHandler` - 2 métodos refatorados
- ✅ `CategoryHandler` - 1 método refatorado
- ✅ `AuthHandler` - 2 métodos refatorados

**Total:** 11 métodos refatorados, removendo ~200 linhas de código duplicado

### Próximos Passos (Opcional)

1. ⏳ Refatorar `BudgetHandler` e `ReportHandler` (se necessário)
2. ⏳ Atualizar use cases para retornar `AppError` diretamente (em vez de depender do mapper)
3. ⏳ Criar tipos de erro específicos por domínio (ex: `TransactionNotFoundError`, `AccountNotFoundError`)
4. ⏳ Adicionar testes para `error_mapper.go`

### Notas Técnicas

- O middleware de erro (`ErrorHandlerMiddleware`) já estava preparado para tratar `AppError`
- O mapper é uma solução transitória - idealmente, use cases deveriam retornar `AppError` diretamente
- O mapper ainda usa string matching internamente, mas de forma centralizada e testável
- Futuramente, podemos criar tipos de erro específicos por domínio para eliminar completamente o string matching

### Commits Realizados

- `feat(qual-001): implementar tratamento de erros consistente com AppError`
- `refactor(qual-001): remover string matching de handlers e usar error mapper`

### Referências

- `backend/pkg/errors/errors.go` - Definição de `AppError`
- `backend/pkg/errors/error_mapper.go` - Mapeamento de erros
- `backend/pkg/middleware/error_handler.go` - Middleware de tratamento de erros
- `docs/RELATORIO_ANALISE_ENGENHARIA_SOFTWARE.md` - Relatório que identificou o problema
