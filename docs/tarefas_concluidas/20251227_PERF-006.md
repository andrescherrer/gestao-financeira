# PERF-006 - Criar índices no banco de dados

**Data:** 2025-12-27  
**Status:** ✅ Concluída

## Resumo da Implementação

**Tarefa:** PERF-006 - Criar índices no banco de dados

### Implementação

Criada migration adicional com índices de performance para otimizar queries comuns, incluindo:
- Índices compostos para queries de relatórios
- Índices para filtros comuns (user_id + date, user_id + type)
- Índices parciais (com WHERE clause) para melhor performance
- Índices para queries de transações recorrentes
- Índices para lookups otimizados

### Arquivos Criados

1. **`migrations/009_add_performance_indexes.sql`**
   - Migration SQL com índices adicionais
   - Índices para transactions, accounts, categories, budgets, users
   - Índices compostos e parciais
   - Comentários explicativos

### Índices Criados

#### Transactions Table

- ✅ `idx_transactions_user_date` - user_id + date (DESC) - Para queries de range de data
- ✅ `idx_transactions_user_type_date` - user_id + type + date (DESC) - Filtro comum
- ✅ `idx_transactions_account_date` - account_id + date (DESC) - Relatórios por conta
- ✅ `idx_transactions_is_recurring` - is_recurring (parcial: WHERE is_recurring = true)
- ✅ `idx_transactions_parent_id` - parent_transaction_id (parcial: WHERE NOT NULL)
- ✅ `idx_transactions_recurrence_end` - recurrence_end_date (parcial: WHERE NOT NULL)
- ✅ `idx_transactions_active_recurring` - user_id + is_recurring + recurrence_end_date (parcial)

#### Accounts Table

- ✅ `idx_accounts_user_active` - user_id + is_active (parcial: WHERE deleted_at IS NULL)
- ✅ `idx_accounts_user_type` - user_id + type (parcial: WHERE deleted_at IS NULL)

#### Categories Table

- ✅ `idx_categories_user_slug` - user_id + slug (parcial: WHERE deleted_at IS NULL)
- ✅ `idx_categories_user_active_optimized` - user_id + is_active (parcial: WHERE deleted_at IS NULL)

#### Budgets Table

- ✅ `idx_budgets_user_period_detail` - user_id + period_type + year + month (parcial)
- ✅ `idx_budgets_category_period` - category_id + period_type + year + month (parcial)

#### Users Table

- ✅ `idx_users_active` - is_active (parcial: WHERE deleted_at IS NULL)

### Benefícios

**Performance:**
- ✅ Queries de relatórios mais rápidas (date range)
- ✅ Filtros combinados otimizados (user + type + date)
- ✅ Lookups por slug mais rápidos
- ✅ Queries de transações recorrentes otimizadas

**Índices Parciais:**
- ✅ Menor tamanho (apenas registros relevantes)
- ✅ Manutenção mais rápida
- ✅ Melhor uso de memória

**Índices Compostos:**
- ✅ Suportam múltiplas condições em uma única busca
- ✅ Evitam múltiplas varreduras de tabela

### Queries Otimizadas

**Relatórios:**
- Monthly/Annual reports (user_id + date range)
- Category reports (user_id + date range)
- Income vs Expense (user_id + type + date)

**Listagens:**
- Transactions by account (account_id + date)
- Active accounts (user_id + is_active)
- Active categories (user_id + is_active)

**Transações Recorrentes:**
- Active recurring transactions (user_id + is_recurring + date)
- Parent-child relationships (parent_transaction_id)

### Aplicação

Para aplicar a migration:

```bash
# Se usando psql diretamente
psql -U postgres -d gestao_financeira -f migrations/009_add_performance_indexes.sql

# Ou através do Docker
docker exec -i gestao-financeira-db-1 psql -U postgres -d gestao_financeira < migrations/009_add_performance_indexes.sql
```

### Verificação

Para verificar se os índices foram criados:

```sql
-- Listar todos os índices de uma tabela
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'transactions'
ORDER BY indexname;

-- Verificar uso de índices
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename = 'transactions'
ORDER BY idx_scan DESC;
```

### Dependências

- ✅ BE-004: Banco de dados configurado
- ✅ Todas as tabelas criadas (migrations 001-008)

### Próximos Passos

- Monitorar performance das queries
- Analisar uso de índices (pg_stat_user_indexes)
- Ajustar índices conforme necessário

---

**Autor:** Sistema de Gestão Financeira  
**Data:** 2025-12-27

