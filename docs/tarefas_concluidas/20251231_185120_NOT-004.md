# NOT-004: Implementar WebSocket para notifica√ß√µes em tempo real

**Data:** 2025-12-31  
**Tarefa:** NOT-004  
**Status:** ‚úÖ Completo  
**Tipo:** üîµ Backend | Infrastructure

---

## üìã Problema

Para fornecer notifica√ß√µes em tempo real aos usu√°rios, era necess√°rio implementar um sistema WebSocket que permitisse comunica√ß√£o bidirecional entre o servidor e os clientes, enviando notifica√ß√µes instantaneamente quando eventos ocorrem no sistema.

---

## ‚úÖ Solu√ß√£o Implementada

Foram implementados:

1. **WebSocket Hub** - Gerenciamento centralizado de conex√µes WebSocket
2. **WebSocket Client** - Cliente individual com leitura/escrita ass√≠ncrona
3. **WebSocket Handler** - Handler HTTP para upgrade de conex√µes
4. **Notification Service** - Servi√ßo para enviar notifica√ß√µes via WebSocket
5. **Event Handler** - Integra√ß√£o com EventBus para enviar notifica√ß√µes automaticamente
6. **Rota WebSocket** - Endpoint `/ws/notifications` para conex√µes WebSocket

---

## üìÅ Arquivos Criados

### Infrastructure - WebSocket
- `backend/internal/notification/infrastructure/websocket/hub.go` - Hub para gerenciar conex√µes
- `backend/internal/notification/infrastructure/websocket/client.go` - Cliente WebSocket individual
- `backend/internal/notification/infrastructure/websocket/notification_service.go` - Servi√ßo para enviar notifica√ß√µes

### Infrastructure - Events
- `backend/internal/notification/infrastructure/events/notification_event_handler.go` - Handler de eventos para WebSocket

### Presentation
- `backend/internal/notification/presentation/handlers/websocket_handler.go` - Handler HTTP para WebSocket

### Depend√™ncias
- `github.com/gofiber/websocket/v2` - Adicionado ao go.mod

---

## üîç Detalhes da Implementa√ß√£o

### WebSocket Hub

O `Hub` gerencia todas as conex√µes WebSocket ativas:

- **Estrutura**:
  - `clients`: Mapa de clientes por userID
  - `register`: Canal para registrar novos clientes
  - `unregister`: Canal para remover clientes
  - `broadcast`: Canal para broadcast (n√£o usado atualmente)

- **Funcionalidades**:
  - `Run()`: Loop principal que gerencia registro/remo√ß√£o de clientes
  - `SendToUser()`: Envia mensagem para todos os clientes de um usu√°rio
  - `GetClientCount()`: Retorna n√∫mero de clientes de um usu√°rio
  - `GetTotalClients()`: Retorna total de clientes ativos

### WebSocket Client

Cada conex√£o WebSocket √© representada por um `Client`:

- **Estrutura**:
  - `hub`: Refer√™ncia ao hub
  - `conn`: Conex√£o WebSocket
  - `send`: Canal para enviar mensagens
  - `userID`: ID do usu√°rio autenticado

- **Funcionalidades**:
  - `ReadPump()`: L√™ mensagens do cliente (ping/pong, etc.)
  - `WritePump()`: Envia mensagens para o cliente
  - Suporte a ping/pong para manter conex√£o viva
  - Timeouts configur√°veis (writeWait, pongWait, pingPeriod)

### WebSocket Handler

O `WebSocketHandler` gerencia o upgrade HTTP para WebSocket:

- **Autentica√ß√£o**:
  - Aceita token JWT via query parameter (`?token=...`)
  - Aceita token JWT via header Authorization (`Bearer ...`)
  - Valida token e extrai userID

- **Upgrade**:
  - Verifica se √© uma requisi√ß√£o de upgrade WebSocket
  - Valida autentica√ß√£o
  - Faz upgrade da conex√£o HTTP para WebSocket

### Notification Service

O `NotificationService` fornece m√©todos para enviar notifica√ß√µes:

- **M√©todos**:
  - `SendNotification()`: Envia notifica√ß√£o completa
  - `SendNotificationUpdate()`: Envia atualiza√ß√£o de notifica√ß√£o (read, archive, etc.)

- **Formato de Mensagem**:
  ```json
  {
    "type": "notification",
    "data": {
      "notification_id": "...",
      "user_id": "...",
      "title": "...",
      "message": "...",
      "type": "INFO",
      "status": "UNREAD",
      "created_at": "..."
    }
  }
  ```

### Event Handler

O `NotificationEventHandler` integra com o EventBus:

- **Subscri√ß√£o**: Escuta eventos `NotificationCreated`
- **Processamento**: Quando uma notifica√ß√£o √© criada, envia via WebSocket automaticamente
- **Logging**: Registra sucessos e falhas

### Integra√ß√£o no main.go

- Hub inicializado e executado em goroutine separada
- NotificationService criado com refer√™ncia ao hub
- NotificationEventHandler criado e subscrito ao EventBus
- WebSocketHandler criado e integrado nas rotas
- Rota `/ws/notifications` configurada

---

## üß™ Testes

### Valida√ß√£o de Compila√ß√£o

```bash
cd backend
go build ./cmd/api/...
```

**Resultado:** Compila√ß√£o bem-sucedida ‚úÖ

---

## üìä Endpoint WebSocket

### URL
```
ws://localhost:8080/ws/notifications?token=<JWT_TOKEN>
```

ou

```
ws://localhost:8080/ws/notifications
Authorization: Bearer <JWT_TOKEN>
```

### Autentica√ß√£o

O WebSocket requer autentica√ß√£o JWT. O token pode ser fornecido de duas formas:

1. **Query Parameter**: `?token=<JWT_TOKEN>`
2. **Authorization Header**: `Authorization: Bearer <JWT_TOKEN>`

### Mensagens Recebidas

#### Notifica√ß√£o Nova
```json
{
  "type": "notification",
  "data": {
    "notification_id": "123e4567-e89b-12d3-a456-426614174000",
    "user_id": "123e4567-e89b-12d3-a456-426614174001",
    "title": "Nova transa√ß√£o",
    "message": "Uma nova transa√ß√£o foi criada",
    "type": "INFO",
    "status": "UNREAD",
    "metadata": {},
    "created_at": "2025-12-31T18:00:00Z"
  }
}
```

#### Atualiza√ß√£o de Notifica√ß√£o
```json
{
  "type": "notification_update",
  "notification_id": "123e4567-e89b-12d3-a456-426614174000",
  "update_type": "read",
  "data": {
    "status": "READ",
    "read_at": "2025-12-31T18:05:00Z"
  }
}
```

### Mensagens Enviadas

#### Ping
```json
{
  "type": "ping"
}
```

**Resposta (Pong)**:
```json
{
  "type": "pong",
  "timestamp": 1704048000
}
```

---

## üîó Integra√ß√µes

O WebSocket est√° integrado com:

- ‚úÖ Sistema de autentica√ß√£o JWT
- ‚úÖ EventBus para eventos de dom√≠nio
- ‚úÖ Sistema de notifica√ß√µes (NotificationRepository)
- ‚úÖ Logging (zerolog)
- ‚úÖ Hub centralizado para gerenciamento de conex√µes

---

## ‚úÖ Valida√ß√£o

- ‚úÖ Compila√ß√£o sem erros
- ‚úÖ Hub gerencia conex√µes corretamente
- ‚úÖ Autentica√ß√£o JWT implementada
- ‚úÖ Ping/Pong para manter conex√£o viva
- ‚úÖ Integra√ß√£o com EventBus
- ‚úÖ Envio autom√°tico de notifica√ß√µes
- ‚úÖ Suporte a m√∫ltiplos clientes por usu√°rio
- ‚úÖ Timeouts e reconex√£o configurados

---

## üìù Notas

- O WebSocket usa ping/pong para manter conex√µes vivas (ping a cada 54 segundos)
- Timeout de leitura: 60 segundos
- Timeout de escrita: 10 segundos
- Tamanho m√°ximo de mensagem: 512 bytes
- M√∫ltiplos clientes podem se conectar com o mesmo usu√°rio (diferentes dispositivos/navegadores)
- Conex√µes s√£o automaticamente limpas quando fechadas

---

## üöÄ Pr√≥ximos Passos

- **FE-NOT-001**: Criar m√≥dulo de notifica√ß√µes no frontend
- **FE-NOT-002**: Integrar WebSocket no frontend

---

**Autor:** Sistema de Gest√£o Financeira  
**Revis√£o:** 2025-12-31

