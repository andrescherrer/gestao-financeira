# INT-002 - Implementar atualização de saldo ao atualizar transação

**Data:** 2025-01-27  
**Status:** ✅ Concluída

## Resumo da Implementação

**Tarefa:** INT-002 - Implementar atualização de saldo ao atualizar transação

### Arquivos Criados

1. **`backend/internal/transaction/domain/events/transaction_updated.go`**
   - Evento de domínio `TransactionUpdated`
   - Contém valores antigos e novos para permitir reversão e reaplicação

### Arquivos Modificados

1. **`backend/internal/transaction/application/usecases/update_transaction_usecase.go`**
   - Captura valores antigos ANTES de fazer atualizações
   - Publica evento `TransactionUpdated` quando amount ou type mudam
   - Evento inclui valores antigos e novos

### Características

- ✅ Captura valores antigos antes de qualquer atualização
- ✅ Detecta mudanças em amount ou type (que afetam saldo)
- ✅ Publica evento apenas se houver mudança relevante
- ✅ Evento contém informações para reversão e reaplicação

### Estrutura do Evento

```go
type TransactionUpdated struct {
    events.BaseDomainEvent
    accountID        string
    oldType          string
    oldAmount        int64
    newType          string
    newAmount        int64
    currency         string
}
```

### Funcionamento

1. **Captura de Valores Antigos:**
   ```go
   oldType := transaction.TransactionType().Value()
   oldAmount := transaction.Amount()
   ```

2. **Atualização da Transação:**
   - Use case atualiza campos conforme input
   - Salva transação atualizada

3. **Detecção de Mudanças:**
   ```go
   amountChanged := !oldAmount.Equals(newAmount)
   typeChanged := oldType != newType
   ```

4. **Publicação do Evento:**
   - Se amount ou type mudaram, publica `TransactionUpdated`
   - Handler reverte efeito antigo e aplica novo efeito

### Handler

O `UpdateBalanceHandler.HandleTransactionUpdated()`:
1. Reverte o efeito da transação antiga:
   - Se era INCOME: debita o valor antigo
   - Se era EXPENSE: credita o valor antigo
2. Aplica o efeito da nova transação:
   - Se é INCOME: credita o valor novo
   - Se é EXPENSE: debita o valor novo

### Testes

- ✅ Teste unitário: Atualização de valor de INCOME
- ✅ Teste unitário: Mudança de INCOME para EXPENSE
- ✅ Testes cobrem todos os cenários de atualização

### Commits Realizados

- `feat(backend): INT-002 - implementar atualização de saldo ao atualizar transação`

### Próxima Tarefa

INT-003 - Implementar atualização de saldo ao deletar transação

