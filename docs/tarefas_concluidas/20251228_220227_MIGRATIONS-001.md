# MIGRATIONS-001 - Migrations Versionadas e Rollback

**Data:** 2025-12-28  
**Status:** ✅ Concluída

## Resumo da Implementação

**Tarefa:** MIGRATIONS-001 - Migrations Versionadas e Rollback

### Arquivos Criados/Modificados

1. **`backend/pkg/migrations/migrations.go`**
   - Funções para gerenciar migrations: `RunMigrations()`, `GetVersion()`, `MigrateDown()`, `MigrateToVersion()`, `ForceVersion()`, `CheckPendingMigrations()`
   - Integração com `golang-migrate/migrate`

2. **`backend/pkg/migrations/migrations_test.go`**
   - Testes unitários para funções de migration (6 casos de teste)
   - Testes de validação de conexão de banco

3. **`backend/cmd/migrate/main.go`**
   - CLI tool para gerenciar migrations
   - Comandos: `up`, `down`, `version`, `goto`, `force`

4. **`backend/migrations/`** (9 migrations versionadas)
   - `000001_create_users_table.up.sql` / `.down.sql`
   - `000002_create_accounts_table.up.sql` / `.down.sql`
   - `000003_create_transactions_table.up.sql` / `.down.sql`
   - `000004_create_categories_table.up.sql` / `.down.sql`
   - `000005_add_slug_to_categories.up.sql` / `.down.sql`
   - `000006_insert_default_user.up.sql` / `.down.sql`
   - `000007_create_budgets_table.up.sql` / `.down.sql`
   - `000008_add_recurrence_fields_to_transactions.up.sql` / `.down.sql`
   - `000009_add_performance_indexes.up.sql` / `.down.sql`

5. **`backend/cmd/api/main.go`**
   - Execução automática de migrations no startup
   - Log de migrations aplicadas

### Características

- ✅ Versionamento de migrations (000001 a 000009)
- ✅ Suporte completo a rollback (arquivos `.down.sql`)
- ✅ Verificação de migrations pendentes no startup
- ✅ CLI tool para gerenciar migrations manualmente
- ✅ Log de migrations aplicadas
- ✅ Testes unitários

### Funções Implementadas

#### RunMigrations()
- Executa todas as migrations pendentes
- Retorna erro se houver problemas
- Log de sucesso ou "No pending migrations"

#### GetVersion()
- Retorna versão atual do banco
- Indica se está em estado "dirty"
- Trata caso de banco sem migrations

#### MigrateDown()
- Faz rollback de N migrations
- Suporta rollback parcial

#### MigrateToVersion()
- Migra para uma versão específica
- Pode fazer upgrade ou downgrade

#### ForceVersion()
- Força o banco para uma versão específica
- Use com cautela (pode causar inconsistências)

#### CheckPendingMigrations()
- Verifica se há migrations pendentes
- Detecta estado "dirty"

### CLI Tool: migrate

```bash
# Aplicar todas as migrations pendentes
./migrate up

# Fazer rollback de 1 migration
./migrate down 1

# Ver versão atual
./migrate version

# Migrar para versão específica
./migrate goto 5

# Forçar versão (use com cautela)
./migrate force 3
```

### Testes

#### migrations_test.go
- ✅ Teste de erro com conexão inválida (RunMigrations)
- ✅ Teste de erro com conexão inválida (GetVersion)
- ✅ Teste de erro com conexão inválida (MigrateDown)
- ✅ Teste de erro com conexão inválida (MigrateToVersion)
- ✅ Teste de erro com conexão inválida (ForceVersion)
- ✅ Teste de erro com conexão inválida (CheckPendingMigrations)

### Integração no Startup

O `main.go` agora executa migrations automaticamente:

```go
// Run migrations
if err := migrations.RunMigrations(db, cfg.Migrations.Path); err != nil {
    log.Fatal().Err(err).Msg("Failed to run migrations")
}
```

### Commits Realizados

- `feat(backend): MIGRATIONS-001 - migrations versionadas e rollback`
- `test(backend): adicionar testes para migrations`

### Próxima Tarefa

CONFIG-001 - Configuração Centralizada
