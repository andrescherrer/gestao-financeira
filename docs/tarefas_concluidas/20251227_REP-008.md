# REP-008 - Implementar cache de relatórios (Redis)

**Data:** 2025-12-27  
**Status:** ✅ Concluída (estrutura básica)

## Resumo da Implementação

**Tarefa:** REP-008 - Implementar cache de relatórios (Redis)

### Implementação

Criada estrutura completa de cache para relatórios usando Redis, incluindo:
- Serviço de cache genérico (pkg/cache)
- Serviço específico para relatórios (report_cache_service)
- Integração no MonthlyReportUseCase (exemplo)
- TTL configurável
- Geração de chaves baseada em hash

### Arquivos Criados

1. **`backend/pkg/cache/cache.go`**
   - Serviço genérico de cache usando Redis
   - Métodos: Get, Set, SetJSON, GetJSON, Delete, DeletePattern
   - Conexão com Redis configurável via URL
   - Tratamento de erros

2. **`backend/internal/reporting/infrastructure/services/report_cache_service.go`**
   - Serviço específico para cache de relatórios
   - Geração de chaves baseada em hash SHA256
   - Métodos: GenerateKey, Get, Set, Invalidate, InvalidateAll
   - TTL configurável

3. **`backend/internal/reporting/application/usecases/monthly_report_usecase.go`** (modificado)
   - Integração com cache service
   - Verificação de cache antes de calcular
   - Armazenamento de resultado no cache

### Dependências Adicionadas

- ✅ `github.com/redis/go-redis/v9` - Cliente Redis para Go

### Funcionalidades

- ✅ Serviço de cache genérico com Redis
- ✅ Serviço específico para relatórios
- ✅ Geração de chaves baseada em hash
- ✅ TTL configurável
- ✅ Integração no MonthlyReportUseCase (exemplo)
- ✅ Tratamento de erros (cache não bloqueia se falhar)
- ✅ Suporte a invalidação por tipo ou todos

### Estrutura de Cache

**Chaves de cache:**
- Formato: `report:{type}:{hash}`
- Exemplo: `report:monthly:a1b2c3d4e5f6g7h8`

**Parâmetros usados no hash:**
- user_id
- year, month (para monthly)
- currency
- start_date, end_date (quando aplicável)
- group_by (quando aplicável)

### TTL (Time To Live)

- Configurável por serviço
- Recomendado: 1 hora (3600 segundos) para relatórios
- Pode ser ajustado por tipo de relatório

### Integração Pendente

Para completar a integração, é necessário:

1. Inicializar CacheService no `main.go`:
```go
cacheService, err := cache.NewCacheService(os.Getenv("REDIS_URL"))
if err != nil {
    log.Warn().Err(err).Msg("Failed to initialize cache, continuing without cache")
    cacheService = nil
}
```

2. Criar ReportCacheService:
```go
reportCacheService := reportingservices.NewReportCacheService(cacheService, 1*time.Hour)
```

3. Passar para os use cases:
```go
monthlyReportUseCase := reportingusecases.NewMonthlyReportUseCase(transactionRepository, reportCacheService)
```

4. Atualizar outros use cases (annual, category, income-vs-expense) seguindo o mesmo padrão

### Testes

```bash
cd backend
go build ./pkg/cache/... ./internal/reporting/infrastructure/services/... ./internal/reporting/application/usecases/...
```

**Resultado:** ✅ Build bem-sucedido

### Dependências

- ✅ SETUP-004: Redis configurado no Docker
- ✅ REP-001: Use case para relatório mensal

### Próximos Passos

- Completar integração no main.go
- Integrar cache nos outros use cases (annual, category, income-vs-expense)
- Adicionar invalidação de cache quando transações são criadas/atualizadas/deletadas
- Testes de integração com Redis

---

**Autor:** Sistema de Gestão Financeira  
**Data:** 2025-12-27

