# NOT-002: Implementar reposit√≥rio e use cases

**Data:** 2025-12-31  
**Tarefa:** NOT-002  
**Status:** ‚úÖ Completo  
**Tipo:** üîµ Backend | Application & Infrastructure

---

## üìã Problema

Para completar a implementa√ß√£o do contexto de Notification, era necess√°rio implementar a camada de persist√™ncia (reposit√≥rio) e a camada de aplica√ß√£o (use cases) que conectam o dom√≠nio com a infraestrutura e a apresenta√ß√£o.

---

## ‚úÖ Solu√ß√£o Implementada

Foram implementados:

1. **Reposit√≥rio de Dom√≠nio** - Interface e implementa√ß√£o GORM
2. **Model de Persist√™ncia** - Model GORM para a tabela notifications
3. **DTOs** - Data Transfer Objects para entrada e sa√≠da
4. **Use Cases** - Casos de uso para opera√ß√µes CRUD e espec√≠ficas de Notification
5. **Migration** - Script SQL para criar a tabela notifications
6. **Testes** - Valida√ß√£o de compila√ß√£o

---

## üìÅ Arquivos Criados

### Domain Repository
- `backend/internal/notification/domain/repositories/notification_repository.go` - Interface do reposit√≥rio

### Infrastructure
- `backend/internal/notification/infrastructure/persistence/notification_model.go` - Model GORM com suporte a JSONB
- `backend/internal/notification/infrastructure/persistence/gorm_notification_repository.go` - Implementa√ß√£o GORM

### Application DTOs
- `backend/internal/notification/application/dtos/create_notification_dto.go` - DTOs de cria√ß√£o
- `backend/internal/notification/application/dtos/list_notifications_dto.go` - DTOs de listagem
- `backend/internal/notification/application/dtos/get_notification_dto.go` - DTOs de consulta
- `backend/internal/notification/application/dtos/mark_read_dto.go` - DTOs de marca√ß√£o como lida
- `backend/internal/notification/application/dtos/mark_unread_dto.go` - DTOs de marca√ß√£o como n√£o lida
- `backend/internal/notification/application/dtos/archive_dto.go` - DTOs de arquivamento
- `backend/internal/notification/application/dtos/delete_notification_dto.go` - DTOs de exclus√£o

### Application Use Cases
- `backend/internal/notification/application/usecases/create_notification_usecase.go` - Criar notifica√ß√£o
- `backend/internal/notification/application/usecases/list_notifications_usecase.go` - Listar notifica√ß√µes
- `backend/internal/notification/application/usecases/get_notification_usecase.go` - Obter notifica√ß√£o
- `backend/internal/notification/application/usecases/mark_read_usecase.go` - Marcar como lida
- `backend/internal/notification/application/usecases/mark_unread_usecase.go` - Marcar como n√£o lida
- `backend/internal/notification/application/usecases/archive_notification_usecase.go` - Arquivar notifica√ß√£o
- `backend/internal/notification/application/usecases/delete_notification_usecase.go` - Excluir notifica√ß√£o

### Migrations
- `backend/migrations/000012_create_notifications_table.up.sql` - Cria√ß√£o da tabela
- `backend/migrations/000012_create_notifications_table.down.sql` - Remo√ß√£o da tabela

---

## üîç Detalhes da Implementa√ß√£o

### Reposit√≥rio

#### NotificationRepository Interface
- `FindByID`: Busca notifica√ß√£o por ID
- `FindByUserID`: Busca todas as notifica√ß√µes de um usu√°rio
- `FindByUserIDWithFiltersWithPagination`: Busca com filtros e pagina√ß√£o
- `FindUnreadByUserID`: Busca notifica√ß√µes n√£o lidas
- `Save`: Salva ou atualiza notifica√ß√£o
- `Delete`: Exclui notifica√ß√£o (soft delete)
- `Exists`: Verifica exist√™ncia
- `Count`: Conta total de notifica√ß√µes
- `CountUnread`: Conta notifica√ß√µes n√£o lidas

#### GormNotificationRepository
- Implementa√ß√£o completa usando GORM
- Convers√£o entre model e entidade de dom√≠nio
- Suporte a JSONB para metadados
- Filtros por status e tipo
- Pagina√ß√£o com offset/limit

### Model de Persist√™ncia

#### NotificationModel
- Campos: ID, UserID, Title, Message, Type, Status, ReadAt, Metadata (JSONB), CreatedAt, UpdatedAt, DeletedAt
- Suporte a soft delete
- Tipo JSONB customizado para metadados

### DTOs

Todos os DTOs incluem valida√ß√µes usando tags `validate`:
- `CreateNotificationInput`: UserID, Title, Message, Type, Metadata
- `ListNotificationsInput`: UserID, Status (opcional), Type (opcional), Page, PageSize
- `GetNotificationInput`: NotificationID, UserID
- `MarkNotificationReadInput`: NotificationID, UserID
- `MarkNotificationUnreadInput`: NotificationID, UserID
- `ArchiveNotificationInput`: NotificationID, UserID
- `DeleteNotificationInput`: NotificationID, UserID

### Use Cases

#### CreateNotificationUseCase
- Valida entrada
- Cria value objects
- Cria entidade Notification
- Salva no reposit√≥rio
- Publica eventos de dom√≠nio

#### ListNotificationsUseCase
- Suporta filtros por status e tipo
- Pagina√ß√£o (padr√£o: 20 itens, m√°ximo: 100)
- Ordena√ß√£o por data de cria√ß√£o (mais recente primeiro)
- Retorna total e total de p√°ginas

#### GetNotificationUseCase
- Busca notifica√ß√£o por ID
- Verifica propriedade (userID)
- Retorna erro 404 se n√£o encontrada
- Retorna erro 403 se n√£o pertence ao usu√°rio

#### MarkNotificationReadUseCase
- Marca notifica√ß√£o como lida
- Atualiza timestamp ReadAt
- Verifica propriedade

#### MarkNotificationUnreadUseCase
- Marca notifica√ß√£o como n√£o lida
- Remove timestamp ReadAt
- Verifica propriedade

#### ArchiveNotificationUseCase
- Arquiva notifica√ß√£o
- Verifica propriedade

#### DeleteNotificationUseCase
- Exclui notifica√ß√£o (soft delete)
- Verifica propriedade

### Migration

A migration cria:
- Tabela `notifications` com todas as colunas necess√°rias
- √çndices para performance:
  - `idx_notifications_user_id`
  - `idx_notifications_status`
  - `idx_notifications_type`
  - `idx_notifications_created_at`
  - `idx_notifications_deleted_at`
  - `idx_notifications_user_status` (composite)
- Foreign key para `users(id)`
- Trigger para atualizar `updated_at` automaticamente
- Constraints CHECK para Type e Status

---

## üß™ Testes

### Valida√ß√£o de Compila√ß√£o

```bash
cd backend
go build ./internal/notification/...
```

**Resultado:** Compila√ß√£o bem-sucedida ‚úÖ

---

## üìä Estrutura de Dados

### NotificationModel

```go
type NotificationModel struct {
    ID        string         // UUID
    UserID    string         // UUID
    Title     string         // VARCHAR(200)
    Message   string         // VARCHAR(1000)
    Type      string         // INFO, WARNING, SUCCESS, ERROR
    Status    string         // UNREAD, READ, ARCHIVED
    ReadAt    *time.Time     // Timestamp (nullable)
    Metadata  JSONB          // JSONB
    CreatedAt time.Time
    UpdatedAt time.Time
    DeletedAt gorm.DeletedAt // Soft delete
}
```

---

## üîó Integra√ß√µes

O reposit√≥rio e use cases est√£o preparados para:

- Integra√ß√£o com handlers HTTP (pr√≥xima tarefa: NOT-003)
- Publica√ß√£o de eventos de dom√≠nio via EventBus
- Integra√ß√£o com sistema de WebSocket (tarefa: NOT-004)
- Cria√ß√£o de notifica√ß√µes a partir de eventos de outros contextos

---

## ‚úÖ Valida√ß√£o

- ‚úÖ Compila√ß√£o sem erros
- ‚úÖ Valida√ß√µes de neg√≥cio implementadas
- ‚úÖ Padr√£o DDD seguido corretamente
- ‚úÖ Consist√™ncia com outros contextos do projeto
- ‚úÖ Suporte a pagina√ß√£o e filtros
- ‚úÖ Soft delete implementado
- ‚úÖ Verifica√ß√£o de propriedade em todas as opera√ß√µes

---

## üìù Notas

- O reposit√≥rio suporta metadados flex√≠veis usando JSONB, permitindo armazenar informa√ß√µes contextuais adicionais
- A pagina√ß√£o tem valores padr√£o sensatos (20 itens por p√°gina, m√°ximo 100)
- Todas as opera√ß√µes verificam a propriedade da notifica√ß√£o para garantir seguran√ßa
- O sistema de status permite rastrear o ciclo de vida completo de uma notifica√ß√£o

---

## üöÄ Pr√≥ximos Passos

- **NOT-003**: Criar handlers e rotas
- **NOT-004**: Implementar WebSocket para notifica√ß√µes em tempo real

---

**Autor:** Sistema de Gest√£o Financeira  
**Revis√£o:** 2025-12-31

